# 彩票分析系统 - 项目说明文档

## 一、项目规划

### 1.1 项目概述
开发一个彩票分析系统，包含DNA查询功能、九转连环图、数据库管理等功能，支持双色球和大乐透两种彩票类型。

### 1.2 核心功能模块
1. **DNA查询功能**：根据输入的号码查询历史中奖情况
2. **九转连环图**：可视化展示号码分布规律
3. **数据库管理**：管理历史开奖数据
4. **数据分析**：提供多种分析指标（和值、跨度、连号、三区、奇偶、AC值、大小比、质合比）

### 1.3 技术方案
- **前端技术**：HTML5、CSS3、JavaScript (ES6+)
- **数据存储**：LocalStorage / IndexedDB
- **可视化**：Canvas、ECharts
- **架构模式**：事件委托模式、类组件化

## 二、实施方案

### 2.1 开发阶段划分

#### 第一阶段：基础功能开发
- [x] 创建基础HTML结构和CSS样式
- [x] 实现数据库管理功能（LocalStorage/IndexedDB）
- [x] 实现数据导入导出功能
- [x] 实现基础数据展示功能

#### 第二阶段：核心功能开发
- [x] 实现DNA查询功能
- [x] 实现九转连环图功能
- [x] 实现数据分析指标计算
- [x] 实现数据库显示优化（红球红色圆球、蓝球蓝色圆球）
- [x] 实现九转图弹窗功能（高亮显示选中号码）
- [x] 实现DNA分析弹窗功能（显示历史中奖情况）

#### 第三阶段：功能优化
- [x] 添加默认号码功能（双色球：05,07,14,20,23,27+16；大乐透：01,13,15,21,27+11,12）
- [x] 删除基础分析菜单
- [x] 优化弹窗显示效果
- [ ] 性能优化
- [ ] 用户体验优化

#### 第四阶段：测试与部署
- [ ] 功能测试
- [ ] 性能测试
- [ ] 兼容性测试
- [ ] 部署上线

## 三、进度记录

### 2026-01-11
- **已完成**：
  - 完成高级分析-相关性分析功能优化：
    - **新增号码相关性分析功能**：
      - 添加号码相关性计算（calculateNumberCorrelation）- 使用共现矩阵计算号码间的相关系数
      - 添加维度相关性计算（calculateDimensionCorrelation）- 使用Pearson相关系数计算维度间的相关性
      - 添加关联网络数据计算（calculateNetworkData）- 计算号码间的共现次数和关联强度
      - 添加相关性统计计算（calculateCorrelationStatistics）- 计算平均相关系数、最强相关对、高相关对数等统计指标
    
    - **新增ECharts可视化图表**：
      - 添加号码相关性热力图（updateCorrelationHeatmap）- 使用热力图展示号码间的相关系数，支持悬停提示显示详细相关性信息
      - 添加维度相关性散点图（updateCorrelationScatter）- 使用散点图展示维度间的相关性，支持悬停提示显示详细维度信息
      - 添加关联网络图（updateCorrelationNetwork）- 使用网络图展示号码间的关联关系，节点大小表示出现频率，连线粗细表示共现次数
    
    - **新增分析结论生成功能**：
      - 添加号码相关性分析结论 - 展示最强相关对、高相关对数、平均相关系数等信息
      - 添加维度相关性分析结论 - 展示最强维度相关和相关系数
      - 添加关联网络分析结论 - 展示节点数量、连线数量等网络信息
    
    - **新增号码推荐功能**：
      - 添加基于高相关对的推荐模式 - 推荐相关性强的号码组合
      - 添加基于低相关对的推荐模式 - 推荐相关性弱的号码组合
      - 添加平衡推荐模式 - 综合考虑高相关和低相关号码
      - 支持相关系数阈值调整，灵活控制推荐结果
    
    - **新增报告导出功能**：
      - 添加相关性分析报告导出功能 - 将分析结果导出为文本格式
      - 包含分析期数、号码相关性、维度相关性、关联网络、分析结论、推荐号码等信息
    
    - **增强交互功能**：
      - 添加图表类型切换标签页 - 支持在号码相关性、维度相关性、关联网络之间切换
      - 添加期数选择功能 - 支持选择最近10期、20期、30期、50期、100期、200期、全部期数
      - 所有图表支持悬停提示，显示详细数据信息
      - 所有图表在打开时自动调整大小
    
    - **更新导航逻辑**：
      - 修复相关性分析菜单项显示问题 - 从"开发中"功能列表中移除
      - 添加独立的case处理逻辑，正确显示相关性分析卡片
      - 确保图表在打开时正确调整大小
    
    - **添加全局变量**：
      - correlationAnalysisData - 相关性分析数据存储
      - correlationHeatmapChart - 相关性热力图实例
      - correlationScatterChart - 相关性散点图实例
      - correlationNetworkChart - 相关性网络图实例
      - currentCorrelationChartType - 当前显示的相关性图表类型
      - currentCorrelationPeriod - 当前相关性分析期数
      - correlationAnalysisResults - 相关性分析结果存储

- **进行中**：
  - 测试所有优化功能

- **待完成**：
  - 功能测试
  - 性能测试
  - 兼容性测试
  - 部署上线

### 2026-01-11
- **已完成**：
  - 完成趋势分析功能增强优化：
    - **新增号码规律分析功能**：
      - 添加同尾号规律分析（analyzeSameTailPattern）- 分析近30期各尾数出现频率，识别热尾号码
      - 添加和值规律分析（analyzeSumPattern）- 分析近50期和值范围、平均值和趋势，提供选号建议
      - 添加跨度规律分析（analyzeSpanPattern）- 分析近50期跨度范围、平均值和趋势，提供选号建议
      - 添加奇偶比规律分析（analyzeOddEvenPattern）- 分析近50期奇偶比分布，识别热门组合
    
    - **新增ECharts可视化图表**：
      - 添加和值趋势图表（updateSumTrendChart）- 使用折线图展示近50期和值变化趋势，包含平均值参考线和面积填充
      - 添加跨度趋势图表（updateSpanTrendChart）- 使用柱状图展示近50期跨度变化，根据偏离度使用不同颜色标识
      - 添加奇偶比趋势图表（updateOddEvenTrendChart）- 使用双折线图展示奇数和偶数数量变化趋势
      - 添加同尾号热力图（updateSameTailHeatmap）- 使用热力图展示各尾数组合同时出现的频率
    
    - **增强ECharts图表交互功能**：
      - 和值趋势图表支持点击事件 - 显示期号、和值、红球号码、平均值和偏离度详情
      - 跨度趋势图表支持点击事件 - 显示期号、跨度、最小号码、最大号码、红球号码、平均值和偏离度详情
      - 奇偶比趋势图表支持点击事件 - 显示期号、奇数号码、偶数号码和奇偶比详情
      - 同尾号热力图支持点击事件 - 显示尾数组合同时出现次数和出现期号
      - 所有图表支持悬停提示，显示详细数据信息
    
    - **优化界面布局**：
      - 调整规律分析网格布局，从2列改为3列，容纳新增的同尾号、和值、跨度、奇偶比分析
      - 添加新图表容器，使用渐变色标题和图标，提升视觉效果
      - 保持与现有界面风格一致的配色方案
    
    - **完善数据更新流程**：
      - 在updateAnalysis方法中添加新图表更新调用
      - 确保所有新图表在数据更新时自动刷新
      - 所有图表支持动态期数调整（最多显示50期）
    
    - **修复趋势分析菜单项显示问题**：
      - 修复趋势分析菜单项点击后显示"开发中"界面的问题
      - 修改趋势分析菜单项事件处理，使其正确打开频率分析卡片
      - 频率分析卡片包含所有新增的趋势分析图表（和值、跨度、奇偶比、同尾号）
      - 确保图表在打开时正确调整大小
      - 修复JavaScript语法错误 - 为case语句添加块级作用域，避免重复声明变量
  - 删除未使用的遗留代码 - 移除updatePatternAnalysis、updatePredictionResult及其相关辅助函数，这些函数试图访问不存在的DOM元素，导致"Cannot set properties of null"错误
  - 修复图表调整大小问题 - 修复频率分析、奇偶分析、大小分析、质合分析、AC值分析、三区分析等卡片中试图调整不存在的图表大小的问题，确保只调整实际存在的图表

- **进行中**：
  - 测试所有优化功能

- **待完成**：
  - 功能测试
  - 性能测试
  - 兼容性测试
  - 部署上线

### 2026-01-11
- **已完成**：
  - 完成质合分析、策略推荐、回暖组合推荐、号码状态分析四大功能优化：
    - **质合分析功能优化**：
      - 增加周期性分析（analyzePrimeCompositeCycle）- 识别质数数量的上升/下降/稳定周期
      - 增加位置偏好分析（analyzePositionPreference）- 分析每个位置对质数/合数的偏好程度
      - 增加质合比预测（predictPrimeRatio）- 基于加权平均和标准差预测下一期质数数量
      - 增加转换矩阵计算（calculateTransitionMatrix）- 计算不同质合比组合之间的转换概率
      - 增加号码状态历史追踪（trackNumberStatusHistory）- 记录每个号码的历史状态变化
      - 增加状态转换概率分析（calculateStatusTransitionProb）- 分析号码从热/温/冷状态转换的概率
    
    - **策略推荐功能优化**：
      - 增加高级策略推荐（generateAdvancedStrategies）- 包含质合比平衡策略、热号追击策略、冷号追冷策略、周期性策略、位置偏好策略
      - 增加位置偏好策略（generatePositionRecommendations）- 根据每个位置的历史偏好提供选号建议
      - 增加周期性策略（generateCycleStrategies）- 基于当前周期阶段提供策略建议
      - 增加智能预测展示 - 显示预测质数数量和趋势方向，附带置信度
    
    - **回暖组合推荐功能优化**：
      - 增加强度评估 - 将回暖组合分为强势/中等/弱势三个等级
      - 增加连续出现分析（calculateConsecutiveAppearances）- 计算组合连续出现的次数
      - 增加增长率计算 - 计算近期增长率和平均增长率
      - 增加综合评分 - 基于多个因素计算强度评分（0-100分）
      - 增强UI展示 - 显示排名、强度、评分、增长率、连续出现次数等详细信息
    
    - **号码状态分析功能优化**：
      - 增加号码状态摘要展示 - 统计热号、温号、冷号数量及定义
      - 增加号码类型标识 - 显示每个号码是质数还是合数
      - 增加号码频率显示 - 显示每个号码的出现次数
      - 增加状态转换概率预测（generateNumberPrediction）- 基于历史转换概率预测号码下一期状态
      - 增加预测等级 - 高概率/中概率/低概率/稳定
      - 修复号码状态分类逻辑 - 当号码平均遗漏为0时使用整体平均遗漏，避免全部被归类为冷号
       - 修复整体平均遗漏计算 - 过滤掉平均遗漏为0的号码，只计算出现过号码的平均遗漏，避免平均值偏低导致分类错误
      - 增强UI展示 - 状态摘要卡片、号码卡片增强显示（类型标识、频率、预测）
    
    - 增加完整的CSS样式支持 - 为所有新增功能添加对应的样式定义

- **进行中**：
  - 测试所有优化功能

- **待完成**：
  - 功能测试
  - 性能测试
  - 兼容性测试
  - 部署上线

### 2026-01-11
- **已完成**：
  - 完成质合分析、策略推荐、回暖组合推荐、号码状态分析四大功能优化：
    - **质合分析功能优化**：
      - 增加周期性分析（analyzePrimeCompositeCycle）- 识别质数数量的上升/下降/稳定周期
      - 增加位置偏好分析（analyzePositionPreference）- 分析每个位置对质数/合数的偏好程度
      - 增加质合比预测（predictPrimeRatio）- 基于加权平均和标准差预测下一期质数数量
      - 增加转换矩阵计算（calculateTransitionMatrix）- 计算不同质合比组合之间的转换概率
      - 增加号码状态历史追踪（trackNumberStatusHistory）- 记录每个号码的历史状态变化
      - 增加状态转换概率分析（calculateStatusTransitionProb）- 分析号码从热/温/冷状态转换的概率
    
    - **策略推荐功能优化**：
      - 增加高级策略推荐（generateAdvancedStrategies）- 包含质合比平衡策略、热号追击策略、冷号追冷策略、周期性策略、位置偏好策略
      - 增加位置偏好策略（generatePositionRecommendations）- 根据每个位置的历史偏好提供选号建议
      - 增加周期性策略（generateCycleStrategies）- 基于当前周期阶段提供策略建议
      - 增加智能预测展示 - 显示预测质数数量和趋势方向，附带置信度
    
    - **回暖组合推荐功能优化**：
      - 增加强度评估 - 将回暖组合分为强势/中等/弱势三个等级
      - 增加连续出现分析（calculateConsecutiveAppearances）- 计算组合连续出现的次数
      - 增加增长率计算 - 计算近期增长率和平均增长率
      - 增加综合评分 - 基于多个因素计算强度评分（0-100分）
      - 增强UI展示 - 显示排名、强度、评分、增长率、连续出现次数等详细信息
    
    - **号码状态分析功能优化**：
      - 增加号码状态摘要展示 - 统计热号、温号、冷号数量及定义
      - 增加号码类型标识 - 显示每个号码是质数还是合数
      - 增加号码频率显示 - 显示每个号码的出现次数
      - 增加状态转换概率预测（generateNumberPrediction）- 基于历史转换概率预测号码下一期状态
      - 增加预测等级 - 高概率/中概率/低概率/稳定
      - 修复号码状态分类逻辑 - 改用基于相对排名的分类方法，确保热号、温号、冷号都有合理数量
      - 增强UI展示 - 状态摘要卡片、号码卡片增强显示（类型标识、频率、预测）
    
    - 增加完整的CSS样式支持 - 为所有新增功能添加对应的样式定义
    - 删除AC值和三区筛选器 - 简化界面，移除非核心功能，使界面更清晰
    - 修复质合策略推荐页面号码状态分类逻辑 - 移除重复且错误的分类代码，直接使用generatePrimeCompositeData中基于相对排名正确计算的热号、温号、冷号数据，确保号码状态分类的准确性和一致性
    - 修复generatePrimeCompositeData函数中redBallRange引用错误 - 将rules.redBallRange改为rules.redBallRange[1]，确保号码状态数据（热号、温号、冷号）能够正确计算和显示，解决号码状态分析显示全是0个的问题
    - 修复三区分析号码推荐功能 - 修复hotZone和coldZone的数据类型不匹配问题，确保推荐评分计算和显示功能正常工作
    - 添加三区分析推荐CSS样式 - 为三区分析号码推荐功能添加完整的CSS样式定义，包括推荐摘要、推荐卡片、号码球、评分条、区间分解等样式，确保推荐结果能够正确显示
    - 移除三区分析推荐模式筛选条件 - 移除"推荐模式"和"目标三区组合"筛选器，简化推荐生成流程，直接基于分析结论生成推荐
    - 修改三区推荐生成逻辑 - 简化generateThreeZoneRecommendation函数，移除模式参数和目标组合参数，直接使用高频三区组合生成推荐
    - 修复三区分析生成推荐按钮事件监听器 - 修正按钮点击事件处理函数调用，从generateThreeZoneRecommendation改为handleGenerateThreeZoneRecommendation
    - 移除updateThreeZoneRecommendationOptions函数 - 删除已废弃的推荐选项更新函数，因为已移除目标三区组合选择器

- **进行中**：
  - 测试所有优化功能

- **待完成**：
  - 功能测试
  - 性能测试
  - 兼容性测试
  - 部署上线

### 2026-01-05
- **已完成**：
  - 完成彩票类型选择器重构：
    - 将原有的选项卡式彩票类型选择改为顶部水平导航栏下拉选择器
    - 删除原有的双色球、大乐透选项卡按钮
    - 删除导出数据按钮
    - 添加下拉选择器CSS样式，确保与现有界面风格一致
    - 修改HTML结构，使用下拉选择器替换原有选项卡
    - 添加handleLotteryTypeSelectChange方法处理下拉选择器变化
    - 确保双色球在系统启动时默认选中
    - 所有系统功能都依托于下拉选择器选择的彩票类型进行工作
    - 下拉选择器切换时自动更新幻方网格的禁用状态

  - 完成彩票规则配置系统重构：
    - 创建LOTTERY_RULES配置对象，统一管理双色球和大乐透的规则
    - 配置包含：彩票名称、红球数量、红球范围、蓝球数量、蓝球范围、总球数、显示名称、红球名称、蓝球名称、主题色、默认号码等
    - 双色球主题色为#E63946（红色），大乐透主题色为#2A9D8F（青绿色）

  - 完成数据解析逻辑重构：
    - 重构parseAndValidateDrawData函数，使用LOTTERY_RULES配置对象动态适配不同彩票类型
    - 根据彩票类型动态验证红球和蓝球的数量、范围
    - 使用配置对象中的redBallName和blueBallName动态生成错误提示信息
    - 确保数据解析逻辑完全基于配置对象，不再硬编码彩票类型相关参数

  - 完成分析和预测功能重构：
    - 重构handlePrediction函数，使用LOTTERY_RULES配置对象动态初始化红球和蓝球频率统计
    - 重构performFrequencyAnalysis函数，使用配置对象动态设置红球和蓝球的数量和范围
    - 重构analyzeZonePattern函数，使用配置对象动态计算三区划分
    - 重构performHotColdAnalysis函数，使用配置对象动态初始化频率统计
    - 所有分析和预测功能都根据当前选择的彩票类型动态调整参数

  - 完成选号系统功能重构：
    - 重构handleRandomSelect函数，使用配置对象动态生成随机号码
    - 重构handleSaveSelection函数，使用配置对象动态验证选号数量
    - 重构toggleRedBall和toggleBlueBall函数，使用配置对象动态限制选号数量
    - 重构updateSelectionDisplay函数，使用配置对象动态显示选号数量和名称
    - 重构renderNumberLibrary函数，使用配置对象动态显示号码颜色和主题
    - 所有选号系统功能都根据当前选择的彩票类型动态调整

  - 完成界面显示重构：
    - 所有分析指标显示使用配置对象中的redBallName和blueBallName
    - 号码库中的号码显示使用配置对象中的themeColor
    - 蓝球显示根据彩票类型使用不同颜色（双色球#457B9D，大乐透#F4A261）
    - 所有提示信息都使用配置对象中的displayName、redBallName、blueBallName

  - 完成幻方网格功能重构：
    - updateMagicSquareGridByLotteryType函数根据彩票类型动态禁用不符合规则的号码
    - 双色球时禁用34-36号红球
    - 大乐透时禁用36号红球和13-16号蓝球
    - 幻方网格在彩票类型切换时自动更新禁用状态

  - 完成频率分析功能优化：
    - 分析摘要增加蓝球冷号显示，显示格式为"蓝球冷号：XX, XX, XX"
    - 蓝球频率分析使用与红球频率分析同样的ECharts图表样式，但使用蓝色主题（#457B9D）
    - 频率趋势分析优化：期数选择大于最近50期都按50期显示，小于等于50期则按选择的期数显示数据，并修复蓝球值未显示问题
    - 继续完善预测推荐，增加"运行预测"按钮进行预测推荐，点击按钮后执行预测分析并更新预测推荐区域
    - 完善详细数据显示（红球/蓝球）：
      - 添加标签页切换功能，分别显示红球数据和蓝球数据
      - 添加排序功能，支持按号码、出现次数、出现频率、当前遗漏、平均遗漏、最大遗漏排序
      - 支持升序和降序排列
      - 红球数据使用红色主题（#E63946），蓝球数据使用蓝色主题（#457B9D）
      - 标签页切换和排序变化时自动刷新表格数据

  - 完成遗漏分析功能增强：
    - 实现红球和蓝球遗漏分析分离显示，使用标签页切换
    - 红球遗漏使用红色主题（#E63946），蓝球遗漏使用蓝色主题（#457B9D）
    - 添加号码排序功能：顺序（按号码从小到大）、降序（按当前遗漏从大到小）、升序（按当前遗漏从小到大）
    - 实现期数选择功能：支持最近30期、50期、100期、200期、全部期数
    - 实现数据截断功能：根据选择的期数从最新期向前截取数据进行分析
    - 实现详细号码统计表格，包含以下指标：
      - 号码（红球白字/蓝球白字）
      - 当前遗漏
      - 最大遗漏
      - 平均遗漏
      - 状态（热/温/冷）
      - 实际开出次数
      - 理论次数
      - 出现概率(%)
      - 欲出概率(%)
      - 欲出等级（极强/强/中等/弱）
    - 实现智能预测推荐功能：
      - 高欲出红球/蓝球（基于遗漏值和欲出概率分析）
      - 热门红球/蓝球（近期开出频率最高）
    - 实现科学规律分析功能：
      - 使用ECharts图表展示遗漏规律（当前遗漏、平均遗漏、最大遗漏）
      - 生成规律分析结论，包括：
        - 超冷号码（当前遗漏超过平均遗漏2倍）
        - 刚开号码（上一期刚开出）
        - 平均遗漏统计
        - 最大遗漏号码
        - 平衡号码（遗漏接近平均值）
        - 理论遗漏值
    - 添加遗漏分析全局变量：
      - currentOmissionTab：当前遗漏分析标签页（red/blue）
      - currentOmissionSort：当前排序方式（number/asc/desc）
      - currentOmissionPeriod：当前分析期数
      - omissionChartData：遗漏分析图表数据
      - omissionRedChart/omissionBlueChart：红球/蓝球遗漏图表实例
      - omissionAnalysisData：遗漏分析数据存储
      - patternChart：科学规律分析图表实例
    - 实现遗漏分析核心方法：
      - performOmissionAnalysis()：执行遗漏分析
      - updateOmissionChart()：更新遗漏图表
      - updateOmissionTable()：更新遗漏表格
      - generateOmissionPrediction()：生成预测推荐
      - generatePatternAnalysis()：生成科学规律分析
    - 添加遗漏分析事件监听器：
      - 标签页切换事件
      - 排序按钮点击事件
      - 期数选择器变化事件
    - 完成遗漏分析功能测试，所有功能正常运行

  - 完成条件选号功能实现：
    - 在选号系统随机选号按钮前面添加条件选号功能
    - 实现条件选号UI，包含以下参数设置：
      - 和值（最小值-最大值）
      - 跨度（最小值-最大值）
      - 连号（下拉选择：不限/无连号/有连号）
      - 三区（下拉选择：不限/1-2-3/2-2-2/3-2-1/3-3-0/0-3-3）
      - 奇偶（下拉选择：不限/6-0/5-1/4-2/3-3/2-4/1-5/0-6）
      - AC值（最小值-最大值）
      - 大小比（下拉选择：不限/6-0/5-1/4-2/3-3/2-4/1-5/0-6）
      - 质合比（下拉选择：不限/6-0/5-1/4-2/3-3/2-4/1-5/0-6）
    - 实现条件验证函数：
      - validateConditions(numbers, conditions)：验证号码是否符合所有设置的条件
      - checkConsecutive(numbers)：检查是否有连号
      - getThreeZoneCounts(numbers)：获取三区分布
      - getOddEvenCount(numbers)：获取奇偶分布
      - calculateACValue(numbers)：计算AC值
      - getBigSmallCount(numbers)：获取大小比分布
      - getPrimeCompositeCount(numbers)：获取质合比分布
    - 修改随机选号函数，支持条件筛选：
      - handleRandomSelect()：根据设置的条件随机生成符合条件的号码
      - getConditionSettings()：获取用户设置的条件参数
      - 最大尝试次数为10000次，如果未找到符合条件的号码则提示用户调整条件
    - 添加条件选号CSS样式，确保UI与现有界面风格一致
    - 完成条件选号功能测试，所有功能正常运行

- **进行中**：
  - 测试所有功能

- **待完成**：
  - 性能优化
  - 用户体验优化
  - 功能测试
  - 性能测试
  - 兼容性测试
  - 部署上线

### 2026-01-03
- **已完成**：
  - 实现DNA分析弹窗功能，显示历史中奖情况分析
  - 优化弹窗显示，包含开奖号码（彩色圆球）和分析指标（彩色数字）
  - 实现历史数据匹配功能，分为高度相似（≥6个号码匹配）和部分相似（3-5个号码匹配）
  - 修复九转连环图弹窗中的号码高亮显示（红底白字）
  - 添加分析指标显示（和值、跨度、连号、三区、奇偶、AC值、大小比、质合比）
  - 修复代码语法错误，确保无诊断错误
  - 修复九转连环图中红球号码高亮显示问题，使用 `Number()` 转换确保类型匹配
  - 在弹窗中添加内联CSS样式，确保高亮效果正确显示
  - 添加调试信息以便排查问题
  - 优化数据库中DNA按钮弹窗功能，使其与数据管理下DNA查询菜单弹窗功能一致
  - 统一DNA弹窗UI设计：使用渐变背景头部、统计卡片、中奖统计和详细中奖记录
  - 实现奖项等级排序和显示，添加匹配号码的视觉指示
  - 确保代码无语法错误，通过诊断检查
  - 在选号系统已选号码外框旁边添加分析指标显示区域
  - 实现分析指标计算功能（和值、跨度、连号、三区、奇偶、AC值、大小比、质合比）
  - 实现历史最高奖项查询功能，显示该注号码在历史开奖中的最高奖项
  - 更新选号系统逻辑，实时更新分析指标和历史最高奖项
  - 添加CSS样式用于分析指标显示区域，包括指标标签、指标值和历史最高奖项显示
  - 修复 `calculateAnalysisMetrics` 不是静态方法的错误，将该方法改为静态方法
  - 更新所有调用 `calculateAnalysisMetrics` 的地方，使用 `EventDelegate.calculateAnalysisMetrics` 调用
  - 将 `calculateAnalysisMetrics` 方法从 `LotteryDataManager` 类迁移到 `EventDelegate` 类，解决 "Uncaught TypeError: EventDelegate.calculateAnalysisMetrics is not a function" 错误
  - 验证修复完成，确认所有4处调用都正确使用 `EventDelegate.calculateAnalysisMetrics`
  - 修复 "Uncaught TypeError: LotteryDatabase.getInstance is not a function" 错误
  - 将 `queryHistoricalHighestPrize` 方法改为 async 方法，使用 `dataManager.currentDb.getData()` 替代不存在的 `LotteryDatabase.getInstance()`
  - 将所有调用 `updateSelectionDisplay` 的方法改为 async 并使用 await，确保异步操作正确执行
  - 将历史最高奖项改为文本方式显示在分析指标中（质合比的后面），移除独立的 `selectionHistoryHighest` 元素
  - 修改 `queryHistoricalHighestPrize` 方法，使其返回历史最高奖项信息对象
  - 更新 `updateSelectionDisplay` 方法，将历史最高奖项信息整合到分析指标显示区域
  - 优化历史最高奖项显示样式："历史最高："使用黑色字体，奖项等级使用与DNA查询菜单中奖统计相同的颜色方案（一等奖红色、二等奖橙色、三等奖黄色、四等奖青色、五等奖浅蓝色、六等奖紫色等），奖金金额使用黑色字体
  - 修复历史最高奖项显示逻辑，正确显示该注号码在历史开奖信息中最高中奖记录及中奖次数，例如：历史最高：四等奖(2次)
  - 修复历史最高奖项查询中的数据类型匹配问题：将选中的号码转换为字符串格式（两位数补零）后再与数据库中的开奖号码进行比较，确保正确匹配中奖记录
  - 完成号码库功能增强：删除号码库每一行数据后面删除按钮前面的日期
  - 完成号码库功能增强：在号码的前面增加勾选框，支持多选功能
  - 完成号码库功能增强：号码的旁边（后面）增加与已选号码旁边分析指标一样的数据（和值、跨度、连号、三区、奇偶、AC值、大小比、质合比）
  - 完成号码库功能增强：在删除按钮前面增加与数据库下一样的九转图和DNA按钮功能，实现与数据库区域一致的交互体验
  - 优化号码库显示布局，使用彩色圆球展示号码（双色球：红球红色、蓝球蓝色；大乐透：前区绿色、后区橙色）
  - 为号码库中的每一项添加分析指标显示，指标值使用不同颜色区分，提升可读性
  - 完成号码库功能增强：在分析指标后面增加历史最高奖项显示，显示格式为"历史最高：XX(X次)"，奖项等级使用与DNA查询菜单中奖统计相同的颜色方案（一等奖红色、二等奖橙色、三等奖黄色、四等奖青色、五等奖浅蓝色、六等奖紫色等）
  - 将 renderNumberLibrary 方法改为 async 方法，支持异步查询历史最高奖项数据
  - 更新所有调用 renderNumberLibrary 的方法为 async 并使用 await，确保异步操作正确执行
  - 修复号码库全选和批量删除按钮功能，添加 handleSelectAllLibrary 和 handleDeleteLibrary 方法
  - 在事件委托中添加号码库按钮的处理逻辑，实现号码库的全选和批量删除功能
  - 调整DNA查询中查询号码的背景色，从紫色渐变（#667eea 到 #764ba2）改为浅灰色（#f0f2f5），避免与分析指标数值颜色（特别是三区的紫色 #6f42c1 和质合比的深紫色 #6610f2）冲突，提升可读性
  - 同步调整数据库中DNA按钮弹窗的查询号码背景色，保持UI一致性
  - 实现九转连环图数据隔离，为不同区域的图表分配独立实例ID：
    - 数据管理九转连环图子菜单：'data-management-jiuzhuan'
    - 选号系统九转连环图：'selection-system-jiuzhuan'
    - 数据库九转图按钮弹窗：'database-jiuzhuan-{period}'
    - 号码库九转图按钮弹窗：'library-jiuzhuan-{id}'
  - 添加 nineRingInstances 静态属性到 EventDelegate 类，用于存储每个九转连环图实例的数据
  - 修改 initJiuzhuanChart 方法，接受 instanceId 参数并使用实例特定的 selectedNumbers
  - 修改 initNineRingDiagram 方法，接受 instanceId 参数并使用实例特定的 selectedNumbers
  - 修改 updateNineRingHighlight 方法，接受 instanceId 参数并使用实例特定的 selectedNumbers
  - 更新所有调用九转连环图相关方法的地方，传入正确的 instanceId 参数
  - 确保所有九转连环图实例的数据完全隔离，互不影响
  - 完成九转连环图参数标准化：字体类型为Arial, sans-serif，CSS字体大小为48px，JavaScript字体大小动态计算为baseSize * 0.055 * scale
  - 完成九转连环图画布尺寸标准化：所有实例（数据管理、数据库、号码库、选号系统）统一使用560x560px画布尺寸
  - 完成九转连环图圆圈半径标准化：中心0，第一圈73.5px，第二圈126.5px，第三圈179.5px，第四圈232.5px，数字圈半径26.5px
  - 完成九转连环图容器尺寸标准化：所有实例统一使用560x610px容器尺寸，确保布局一致
  - 完成九转连环图scale参数标准化：所有drawNineRingCircle调用统一使用scale=1
  - 完成九转连环图CSS样式标准化：移除所有hover transform效果和transition属性，避免画布放大超出外框
  - 完成九转连环图布局标准化：统一card-container间距为30px，确保视觉一致性
  - 确保所有九转连环图实例（数据管理、数据库、号码库、选号系统）使用相同的配置效果和大小，但保持数据不互通、不干扰
  - 完成基础分析菜单下频率分析功能优化：
    - 分析摘要增加蓝球冷号显示，显示格式为"蓝球冷号：XX, XX, XX"
    - 蓝球频率分析使用与红球频率分析同样的ECharts图表样式，但使用蓝色主题（#457B9D）
    - 频率趋势分析优化：期数选择大于最近50期都按50期显示，小于等于50期则按选择的期数显示数据，并修复蓝球值未显示问题
    - 继续完善预测推荐，增加"运行预测"按钮进行预测推荐，点击按钮后执行预测分析并更新预测推荐区域
    - 完善详细数据显示（红球/蓝球）：
      - 添加标签页切换功能，分别显示红球数据和蓝球数据
      - 添加排序功能，支持按号码、出现次数、出现频率、当前遗漏、平均遗漏、最大遗漏排序
      - 支持升序和降序排列
      - 红球数据使用红色主题（#E63946），蓝球数据使用蓝色主题（#457B9D）
      - 标签页切换和排序变化时自动刷新表格数据

- **进行中**：
  - 测试所有功能

- **待完成**：
  - 性能优化
  - 用户体验优化
  - 功能测试
  - 性能测试
  - 兼容性测试
  - 部署上线

### 2026-01-03（之前）
- **已完成**：
  - 创建基础HTML结构和CSS样式
  - 实现数据库管理功能（LocalStorage/IndexedDB）
  - 实现数据导入导出功能
  - 实现基础数据展示功能
  - 实现DNA查询功能
  - 实现九转连环图功能
  - 实现数据分析指标计算
  - 实现数据库显示优化（红球红色圆球、蓝球蓝色圆球）
  - 实现九转图弹窗功能（高亮显示选中号码）
  - 添加默认号码功能（双色球：05,07,14,20,23,27+16；大乐透：01,13,15,21,27+11,12）
  - 删除基础分析菜单

## 四、技术文档

### 4.1 核心类说明

#### LotteryDatabase
- **功能**：彩票数据库管理类
- **存储方式**：LocalStorage / IndexedDB
- **主要方法**：
  - `init()`：初始化数据库
  - `getData()`：获取数据
  - `saveData(data)`：保存数据
  - `addDraw(draw)`：添加开奖数据
  - `deleteDraw(period)`：删除开奖数据
  - `getDraw(period)`：获取指定期号数据

#### EventDelegate
- **功能**：事件委托管理类
- **主要方法**：
  - `init()`：初始化事件委托
  - `handleLotteryTypeChange()`：处理彩票类型切换
  - `handleDNAQuery()`：处理DNA查询
  - `handleJiuzhuanQuery()`：处理九转查询
  - `showNineChart(period, numbers)`：显示九转图弹窗
  - `showDNAAnalysis(period, numbers)`：显示DNA分析弹窗
  - `calculateAnalysisMetrics(numbers)`：计算分析指标

### 4.2 数据结构

#### 开奖数据结构
```javascript
{
    period: "2024001",        // 期号
    date: "2024-01-01",       // 开奖日期
    redBalls: [1, 5, 10, 15, 20, 25],  // 红球号码
    blueBalls: [7, 12],       // 蓝球号码
    sales: 500000000,         // 销售额
    pool: 1000000000          // 奖池
}
```

#### 九转图数据结构
```javascript
{
    center: 17,  // 中心数字
    rings: [
        [1, 6, 7, 22, 23, 18, 27, 32],  // 第一环
        [33, 29, 19, 12, 3, 15, 5, 20], // 第二环
        [21, 24, 31, 4, 16, 10, 28, 2], // 第三环
        [13, 9, 11, 30, 26, 25, 8, 14]  // 第四环
    ]
}
```

### 4.3 分析指标说明

- **和值**：所有号码之和
- **跨度**：最大号码与最小号码之差
- **连号**：连续号码的数量
- **三区**：号码在三个区间（1-11, 12-22, 23-33）的分布
- **奇偶**：奇数与偶数的比例
- **AC值**：号码复杂度指标
- **大小比**：大号（>16.5）与小号（≤16.5）的比例
- **质合比**：质数与合数的比例

## 五、注意事项

### 5.1 开发规范
- 严格遵循用户规则，不延期、不超计划、不出错
- 每次修改代码后需进行语法检查
- 使用Mac系统进行TRAE编程开发
- 为所有函数添加函数级注释

### 5.2 测试要求
- 功能测试：确保所有功能正常运行
- 性能测试：确保系统响应速度
- 兼容性测试：确保在不同浏览器中正常运行

### 5.3 文档更新
- 每次重新打开项目前，必须先阅读本文档
- 项目计划调整、进度节点变更时，需即时更新文档
- 每完成一项工作任务，需立即在文档进度记录中标记完成并补充结果说明

### 2026-01-12
- **已完成**：
  - 完成统计学模型分析类型优化：
    - **增强推荐号码生成功能**：
      - 添加"趋势组合"（Trend combination）- 基于回归分析结果生成推荐号码
        * 上升趋势：推荐大号区间号码（maxRedBall-5到maxRedBall）
        * 下降趋势：推荐小号区间号码（1到6）
        * 稳定趋势：推荐中间区间号码（中位数前后3个号码）
      - 添加"区间组合"（Interval combination）- 基于ANOVA结果生成推荐号码
        * 识别高频区间（平均出现频率最高的区间）
        * 从高频区间中选择6个号码作为推荐组合
      - 添加"高频组合"（High-frequency combination）- 基于时间序列分析结果生成推荐号码
        * 从时间序列分析的topNumbers中选择前6个高频号码
        * 确保推荐号码按升序排列
    
    - **修复引用错误**：
      - 修复`results.timeseries.highFrequencyNumbers`引用错误
      - 改为使用`results.timeseries.topNumbers`获取高频号码列表
      - 确保高频组合推荐功能正常工作
    
    - **完善推荐类型覆盖**：
      - 现在支持6种推荐类型：热号组合、周期性组合、高频组合、趋势组合、区间组合、高频簇组合、随机组合
      - 确保所有分析类型（假设检验、时间序列、回归分析、方差分析、聚类分析）都有对应的推荐号码
      - 如果推荐数量不足5个，自动生成随机组合补充

  - 完成蒙特卡洛模拟和统计学模型模块UI布局优化：
    - **蒙特卡洛模拟模块布局调整**：
      - 将控制面板从内容区域移到标题后面的header-controls区域
      - 控制面板包含：分析期数选择、模拟次数选择、置信度选择、开始模拟按钮
      - 使用flex布局确保控制面板与标题在同一行显示
      - 保持与现有界面风格一致的配色方案
    
    - **统计学模型模块布局调整**：
      - 将控制面板从内容区域移到标题后面的header-controls区域
      - 控制面板包含：分析期数选择、开始分析按钮
      - 使用flex布局确保控制面板与标题在同一行显示
      - 保持与现有界面风格一致的配色方案
    
    - **增强UI一致性**：
      - 两个模块使用相同的header-controls布局结构
      - 控制面板元素间距和样式保持一致
      - 提升用户体验，使界面更加紧凑和直观

  - 完成组合优化算法模块的阶段1逐期关联分析：
    - **新增阶段1分析功能**：
      - 添加`performComboOptimizationPhase1Analysis`方法 - 执行阶段1逐期关联分析
        * 遍历相邻两期数据，提取每期的号码特征
        * 计算相邻两期之间的模式相似度
        * 统计模式转换频率和规律
        * 识别高频模式转换和低频模式转换
        * 计算模式转换的置信度
      - 添加`extractPatternFeatures`方法 - 提取单期号码的特征
        * 计算号码和值
        * 计算号码跨度
        * 计算奇偶比
        * 计算大小比
        * 计算质合比
        * 计算三区分布
        * 计算AC值
      - 添加`calculatePatternSimilarity`方法 - 计算两个模式的相似度
        * 使用加权欧氏距离计算相似度
        * 和值权重：0.2
        * 跨度权重：0.15
        * 奇偶比权重：0.15
        * 大小比权重：0.15
        * 质合比权重：0.15
        * 三区分布权重：0.1
        * AC值权重：0.1
    
    - **集成阶段1分析到主分析流程**：
      - 修改`performComboOptimizationAnalysis`方法 - 在主分析流程中调用阶段1分析
        * 加载数据后立即执行阶段1分析
        * 将阶段1分析结果传递给指标计算方法
      - 修改`calculateComboOptimizationMetrics`方法 - 接受阶段1数据并返回
        * 将阶段1分析结果包含在返回的分析结果中
        * 确保后续分析可以使用阶段1数据
    
    - **完善阶段1分析结果展示**：
      - 修改`displayComboOptimizationAnalysis`方法 - 在结论中展示阶段1分析结果
        * 添加"逐期关联分析（阶段1）"部分
        * 展示模式转换统计信息
        * 展示高频模式转换和低频模式转换
        * 展示模式转换置信度
        * 基于阶段1分析结果生成选号建议

  - 完成统计学模型时间序列分析优化：
    - **增强时间序列分析数据统计**：
      - 修改`performTimeSeriesAnalysis`方法 - 添加详细的号码统计信息
        * 统计每个号码的出现次数
        * 计算每个号码的平均间隔期数
        * 计算每个号码的最大间隔期数
        * 计算每个号码的最小间隔期数
        * 记录每个号码的最后出现期号
        * 计算每个号码的当前遗漏期数
        * 计算每个号码的出现频率
    
    - **增强时间序列分析结论**：
      - 修改`displayTimeseriesResults`方法 - 添加更详细的分析结论
        * 添加整体趋势分析 - 分析号码出现的整体趋势
        * 添加周期性号码分析 - 识别具有周期性特征的号码
        * 添加高频号码分析 - 分析出现频率最高的号码
        * 添加低频号码分析 - 分析出现频率最低的号码
        * 添加趋势分析 - 分析号码的出现趋势（上升/下降/稳定）
        * 添加间隔分析 - 分析号码的平均间隔和间隔分布
        * 添加遗漏分析 - 分析号码的当前遗漏和遗漏趋势
        * 添加分析说明 - 解释时间序列分析的原理和方法
    
    - **优化时间序列图表可视化**：
      - 修改ECharts配置 - 增强图表展示效果
        * 添加自定义tooltip格式化器 - 显示号码、出现次数、平均间隔、当前遗漏等详细信息
        * 添加图例 - 支持显示/隐藏不同的数据系列
        * 添加双y轴 - 左轴显示出现次数，右轴显示间隔/遗漏
        * 添加平均间隔数据系列 - 显示每个号码的平均间隔期数
        * 添加当前遗漏数据系列 - 显示每个号码的当前遗漏期数
        * 使用不同颜色区分不同的数据系列
        * 添加数据缩放功能 - 支持放大/缩小查看特定区域

- **进行中**：
  - 测试所有优化功能

- **待完成**：
  - 功能测试
  - 性能测试
  - 兼容性测试
  - 部署上线
